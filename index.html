<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LAPORAN KAS GANG MAWAR 3</title>
<style>
:root{
 --bg:#f5f5f5;--card:#ffffff;--text:#000000;--border:#cccccc;--accent:#4caf50;--danger:#d9534f;--success:#28a745;--yellow:#fff200;--font:Arial,sans-serif;
}

/* --- THEME CYBERPUNK FIX --- */
.theme-cyberpunk {
    --bg: #050505 !important;
    --card: #0f0f0f !important;
    --text: #00ffcc !important;
    --border: #ff00ff !important;
    --accent: #ffff00 !important;
    --yellow: #ffff00 !important;
}
.theme-cyberpunk body { background-color: #050505 !important; color: #00ffcc !important; }
.theme-cyberpunk .block { border: 1px solid #00ffcc !important; box-shadow: 0 0 15px rgba(0,255,204,0.3) !important; background: #0f0f0f !important; }
.theme-cyberpunk th { background: #1a1a1a !important; color: #ff00ff !important; border: 1px solid #00ffcc !important; }
.theme-cyberpunk td { border: 1px solid #ff00ff !important; color: #00ffcc !important; }
.theme-cyberpunk input, .theme-cyberpunk textarea { color: #fff !important; text-shadow: 0 0 5px #fff !important; }
.theme-cyberpunk .pulse-line { display: block !important; }

/* --- WELCOME SCREEN --- */
#welcomeScreen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: #000; color: #fff; z-index: 9999; 
    display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
}
#welcomeScreen h1 { font-size: 1.6rem; color: #00ffcc; text-shadow: 0 0 10px #00ffcc; margin: 0 20px 10px; }
#welcomeScreen p { font-size: 0.75rem; color: #aaa; text-transform: none; margin-bottom: 30px; }
#welcomeInput { padding: 12px; width: 280px; border-radius: 8px; border: 2px solid #00ffcc; background: transparent; color: #fff; text-align: center; }
#enterBtn { margin-top: 20px; padding: 12px 60px; background: #00ffcc; color: #000; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; }

/* --- MAIN WRAPPER & SCALING --- */
#mainWrapper {
    width: 1024px; margin: 0; background: var(--bg); padding: 20px;
    transform-origin: 0 0; display: none; box-sizing: border-box; position: relative;
}
body { font-family: var(--font); background: var(--bg); margin: 0; padding: 0; text-transform: uppercase; color: var(--text); }

/* --- BANNER --- */
#deadline-banner { background: #333; color: #fff; padding: 12px; margin: 10px 16px; border-radius: 8px; }
#deadline-text { display: block; font-weight: bold; font-size: 1.2rem; }

/* --- TABLE & UI --- */
.block { margin: 16px; padding: 18px; background: var(--card); border-radius: 14px; box-shadow: 0 4px 12px rgba(0,0,0,.1); }
.pulse-line { display:none; height:2px; width:100%; background:linear-gradient(90deg, transparent, #00ffcc, #ff00ff, transparent); margin-bottom:15px; }
table { width:100%; border-collapse:collapse; }
th, td { border:1px solid var(--border); padding:8px; }
input { padding:6px; border-radius:6px; border:1px solid #ccc; width:100%; text-transform:none; font-family:inherit; }
input[disabled] { background:transparent; color:inherit; border:1px solid transparent; opacity: 1; -webkit-text-fill-color: inherit; }

/* --- NOTE BOX --- */
.note-box { border: 2px dashed var(--border); padding: 20px; border-radius: 12px; margin-top: 20px; }
#catatanWarga { width:100%; background:transparent; border:0; color:inherit; font-size:1.2rem; resize:none; text-transform:none; min-height:100px; overflow:hidden; line-height:1.6; }

/* --- CHECKLIST MODAL FIX --- */
#checklistModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:99999; overflow:auto; padding:10px; }
.checklist-content { background:#fff; color:#000; padding:10px; border-radius:10px; width:1000px; margin: 20px auto; transform-origin: top center; }
.status-v { background:#93c47d !important; }
.status-x { background:#e06666 !important; }

/* MENU */
.menu-container {position:fixed; top:12px; right:12px; z-index:10000; display:flex; flex-direction:column; align-items:flex-end; gap:8px}
.menu-items {display:none; flex-direction:column; gap:8px; background:rgba(0,0,0,0.9); padding:12px; border-radius:8px;}
.menu-items.show {display:flex}
button { padding:10px 16px; border-radius:8px; font-weight:600; cursor:pointer; text-transform:uppercase; border:none; }
button.primary { background:var(--accent); color:#fff; }
</style>
</head>
<body>

<div id="welcomeScreen">
    <h1>SELAMAT DATANG DI WEBSITE KAS GANG MAWAR 3</h1>
    <p>Built and developed by Fajar Ilmanosa Viar &copy; 2026 . All Rights Reserved.</p>
    <input type="text" id="welcomeInput" placeholder="Ketik Nama Anda...">
    <button id="enterBtn" onclick="masukWeb()">ENTER</button>
</div>

<div id="mainWrapper">
    <header style="text-align:center; padding-top:20px;">
      <h1 style="font-size:2.5rem; margin:0;">LAPORAN KAS GANG MAWAR 3</h1>
      <div style="margin:10px 0;">
        <button onclick="prevMonth()">â—€</button>
        <span id="periode" style="min-width:220px; display:inline-block; font-size:1.5rem; font-weight:bold;">...</span>
        <button onclick="nextMonth()">â–¶</button>
      </div>
      <div id="lastUpdate" style="font-size:0.9rem; color:#666; text-transform:none;">TERAKHIR DI UPDATE PADA: -</div>
    </header>

    <div id="deadline-banner">
        <marquee id="deadline-text" scrollamount="6">Mengecek tanggal...</marquee>
    </div>

    <div class="menu-container">
        <button onclick="toggleMenu()" style="background:#333; color:#fff; border:1px solid #fff;">â˜° MENU</button>
        <div class="menu-items" id="menuItems">
            <button id="adminBtn" style="background:#999; color:#fff;">ADMIN OFF</button>
            <button id="pullBtn" style="background:#f0ad4e; color:#fff; display:none;">TARIK SALDO LALU</button>
            <button onclick="openChecklist()" class="primary">CHECKLIST KAS</button>
            <button id="themeBtn" class="primary">GANTI TEMA</button>
            <button id="cetakBtn" class="primary">CETAK LAPORAN</button>
        </div>
    </div>

    <div class="block">
        <h2>PEMASUKAN</h2>
        <div class="pulse-line"></div>
        <table>
            <thead><tr><th>TGL</th><th>NAMA</th><th>KETERANGAN</th><th>MASUK</th><th>SALDO</th></tr></thead>
            <tbody id="tbMasuk"></tbody>
        </table>
    </div>

    <div class="block">
        <h2>PENGELUARAN</h2>
        <div class="pulse-line"></div>
        <table>
            <thead><tr><th>TGL</th><th>KETERANGAN</th><th>QTY</th><th>HARGA</th><th>TOTAL</th></tr></thead>
            <tbody id="tbKeluar"></tbody>
        </table>
    </div>

    <div class="block">
        <h2 style="margin-bottom:10px;">GRAND TOTAL</h2>
        <table style="text-align:center; font-size:1.3rem; font-weight:bold;">
            <tr style="background:#eee; color:#000;"><th>TOTAL MASUK</th><th>TOTAL KELUAR</th><th>SALDO AKHIR</th></tr>
            <tr><td id="totalMasuk" style="background:var(--success); color:#fff;">0</td><td id="totalKeluar" style="background:var(--danger); color:#fff;">0</td><td id="saldoAkhir" style="background:var(--yellow); color:#000;">0</td></tr>
        </table>
    </div>

    <div class="block note-box">
      <h2 style="text-align:left; border-bottom:1px solid #ccc; padding-bottom:5px;">ðŸ“Œ CATATAN PENTING</h2>
      <textarea id="catatanWarga" class="editable" oninput="autoHeight(this)"></textarea>
    </div>
    <div style="height:150px;"></div>
</div>

<div id="checklistModal">
    <div style="text-align:center; position:sticky; top:0; padding:10px; z-index:100;">
        <button onclick="closeChecklist()" style="background:#d9534f; color:#fff; padding:15px 30px;">TUTUP [X]</button>
    </div>
    <div class="checklist-content" id="checklistPrintArea">
        <h1 style="text-align:center; background:#92c694; margin:0; padding:10px;">CHECKLIST KAS GANG MAWAR 3</h1>
        <h2 style="text-align:center; background:#d9ead3; margin:0; border-bottom:2px solid #000;">PERIODE 2026</h2>
        <table style="width:100%; border:2px solid #000; border-collapse:collapse;">
            <thead>
                <tr style="background:#9fc5e8;">
                    <th rowspan="2">No.</th><th rowspan="2">NAMA</th><th colspan="12">CHECKLIST KAS 2026</th>
                </tr>
                <tr style="background:#9fc5e8;">
                    <th>JAN</th><th>FEB</th><th>MAR</th><th>APR</th><th>MEI</th><th>JUN</th><th>JUL</th><th>AGT</th><th>SEP</th><th>OKT</th><th>NOV</th><th>DES</th>
                </tr>
            </thead>
            <tbody id="tbChecklist" style="text-align:center;"></tbody>
        </table>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyAn5Iw4cI8bRSGuyRr3TNNVWzQA-duRHvk",
    authDomain: "kasmawar3-59c18.firebaseapp.com",
    databaseURL: "https://kasmawar3-59c18-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "kasmawar3-59c18",
    storageBucket: "kasmawar3-59c18.firebasestorage.app",
    messagingSenderId: "643313437210",
    appId: "1:643313437210:web:7377bbd6e4cd9aa33b5fa3",
    measurementId: "G-KY0GS26WNT"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let bulan = new Date().getMonth(), tahun = 2026, isAdmin = false;
const namaBulan=['JANUARI','FEBRUARI','MARET','APRIL','MEI','JUNI','JULI','AGUSTUS','SEPTEMBER','OKTOBER','NOVEMBER','DESEMBER'];
const namaAnggota=['SISA KAS SEBELUMNYA','RIZAL','ROMI','TRI','ANIS','FAJAR DJAKA','FAJAR SHANUM','AGUS','LUKMAN','IRAWAN','RIAN','MULYADIE','HELDI','HILMAN','NANO','TEGUH'];

function applyResponsiveScale() {
    const wrapper = document.getElementById('mainWrapper');
    if (wrapper.style.display === 'none') return;
    const scale = window.innerWidth / 1024;
    wrapper.style.transform = `scale(${scale})`;
    document.body.style.height = (wrapper.scrollHeight * scale + 100) + "px";
}

function masukWeb() {
    if (document.getElementById('welcomeInput').value.trim() === "") return alert("Isi Nama!");
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('mainWrapper').style.display = 'block';
    setTimeout(() => { applyResponsiveScale(); autoHeight(document.getElementById('catatanWarga')); }, 100);
}

function autoHeight(el) {
    if (!el) return;
    el.style.height = 'auto';
    el.style.height = el.scrollHeight + 'px';
    applyResponsiveScale();
}

function updateDeadlineBanner() {
    const d = new Date().getDate();
    const txt = document.getElementById('deadline-text');
    if (d <= 3) txt.innerHTML = "âš ï¸ REMINDER: BATAS IURAN KAS BULAN INI TANGGAL 7 âš ï¸ TERIMA KASIH";
    else if (d <= 7) txt.innerHTML = "âš ï¸ PERHATIAN: BATAS BAYAR KAS S/D TANGGAL 7 âš ï¸ SEGERA BAYAR";
    else txt.innerHTML = "ðŸ›‘ BATAS BAYAR KAS SUDAH LEWAT ðŸ›‘ MOHON KERJASAMANYA";
}

function buildTables() {
    const tm = document.getElementById('tbMasuk'); tm.innerHTML = '';
    namaAnggota.forEach(n => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input class="editable" type="date"></td><td><input class="editable" value="${n}"></td><td><input class="editable"></td><td><input class="editable" value="0"></td><td class="saldo">0</td>`;
        tm.appendChild(tr);
    });
    const tk = document.getElementById('tbKeluar'); tk.innerHTML = '';
    for(let i=0; i<12; i++) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input class="editable" type="date"></td><td><input class="editable"></td><td><input class="editable" value="0"></td><td><input class="editable" value="0"></td><td class="total">0</td>`;
        tk.appendChild(tr);
    }
}

function recalc() {
    let tM=0, tK=0, runM=0;
    document.querySelectorAll('#tbMasuk tr').forEach(tr => {
        let u = parseInt(tr.children[3].firstChild.value.replace(/\./g,'')) || 0;
        runM += u; tM += u;
        tr.children[3].firstChild.value = u.toLocaleString('id-ID');
        tr.children[4].innerText = runM.toLocaleString('id-ID');
        const ket = tr.children[2].firstChild.value.toUpperCase();
        const inputs = tr.querySelectorAll('input');
        if (ket.includes('BELUM')) { inputs.forEach(i => i.style.background = '#d9534f'); }
        else if (["LUNAS","SUDAH","SISA"].some(k => ket.includes(k))) { inputs.forEach(i => i.style.background = '#28a745'); }
        else { inputs.forEach(i => i.style.background = 'transparent'); }
    });
    document.querySelectorAll('#tbKeluar tr').forEach(tr => {
        let q = parseInt(tr.children[2].firstChild.value) || 0;
        let h = parseInt(tr.children[3].firstChild.value.replace(/\./g,'')) || 0;
        let t = q * h; tK += t;
        tr.children[3].firstChild.value = h.toLocaleString('id-ID');
        tr.children[4].innerText = t.toLocaleString('id-ID');
    });
    document.getElementById('totalMasuk').innerText = tM.toLocaleString('id-ID');
    document.getElementById('totalKeluar').innerText = tK.toLocaleString('id-ID');
    document.getElementById('saldoAkhir').innerText = (tM-tK).toLocaleString('id-ID');
}

function loadData() {
    buildTables();
    db.ref('kas_data/'+bulan+'-'+tahun).once('value', s => {
        const d = s.val();
        if(d) {
            if(d.masuk) d.masuk.forEach((r,i) => { 
                const tr = document.querySelectorAll('#tbMasuk tr')[i];
                if(tr) { tr.children[0].firstChild.value=r.tanggal; tr.children[1].firstChild.value=r.nama; tr.children[2].firstChild.value=r.ket; tr.children[3].firstChild.value=r.uang; }
            });
            if(d.keluar) d.keluar.forEach((r,i) => {
                const tr = document.querySelectorAll('#tbKeluar tr')[i];
                if(tr) { tr.children[0].firstChild.value=r.tanggal; tr.children[1].firstChild.value=r.ket; tr.children[2].firstChild.value=r.qty; tr.children[3].firstChild.value=r.harga; }
            });
            document.getElementById('lastUpdate').innerText = "TERAKHIR DI UPDATE PADA: " + (d.updated || "-");
        }
        recalc(); applyAdminLock();
    });
    db.ref('kas_data/catatan_umum').once('value', s => { 
        document.getElementById('catatanWarga').value = s.val() || ''; 
        autoHeight(document.getElementById('catatanWarga'));
    });
}

function saveData() {
    if(!isAdmin) return;
    const now = new Date();
    const upstr = now.getDate() + " " + namaBulan[now.getMonth()] + " " + now.getFullYear() + " " + now.getHours() + ":" + now.getMinutes();
    const m = [...document.querySelectorAll('#tbMasuk tr')].map(tr => ({tanggal:tr.children[0].firstChild.value, nama:tr.children[1].firstChild.value, ket:tr.children[2].firstChild.value, uang:tr.children[3].firstChild.value}));
    const k = [...document.querySelectorAll('#tbKeluar tr')].map(tr => ({tanggal:tr.children[0].firstChild.value, ket:tr.children[1].firstChild.value, qty:tr.children[2].firstChild.value, harga:tr.children[3].firstChild.value}));
    db.ref('kas_data/'+bulan+'-'+tahun).update({masuk:m, keluar:k, updated:upstr});
    db.ref('kas_data/catatan_umum').set(document.getElementById('catatanWarga').value);
}

async function openChecklist() {
    toggleMenu();
    document.getElementById('checklistModal').style.display = 'block';
    const tb = document.getElementById('tbChecklist'); tb.innerHTML = 'Memuat...';
    const matrix = {};
    for (let m=0; m<12; m++) {
        const s = await db.ref(`kas_data/${m}-${tahun}`).once('value');
        const d = s.val();
        namaAnggota.forEach((nama, idx) => {
            if(idx===0) return;
            if(!matrix[nama]) matrix[nama] = Array(12).fill('X');
            if(d && d.masuk) {
                const r = d.masuk.find(x => x.nama === nama);
                if(r && ["LUNAS","SUDAH"].some(k => (r.ket||'').toUpperCase().includes(k))) matrix[nama][m] = 'âœ“';
            }
        });
    }
    tb.innerHTML = '';
    Object.keys(matrix).forEach((n, i) => {
        const tr = document.createElement('tr');
        let h = `<td>${i+1}</td><td style="text-align:left; padding-left:10px;">${n}</td>`;
        matrix[n].forEach(v => h += `<td class="${v==='âœ“'?'status-v':'status-x'}">${v}</td>`);
        tr.innerHTML = h; tb.appendChild(tr);
    });
}

function closeChecklist() { document.getElementById('checklistModal').style.display = 'none'; }
function toggleMenu() { document.getElementById('menuItems').classList.toggle('show'); }
function applyAdminLock() { document.querySelectorAll('.editable').forEach(i => i.disabled = !isAdmin); }
function prevMonth() { bulan--; if(bulan<0){bulan=11; tahun--;} updateUI(); }
function nextMonth() { bulan++; if(bulan>11){bulan=0; tahun++;} updateUI(); }
function updateUI() { document.getElementById('periode').innerText = namaBulan[bulan] + " " + tahun; loadData(); }

document.getElementById('adminBtn').onclick = function() {
    if(!isAdmin) {
        if(prompt('USER')==='ADMIN' && prompt('PASS')==='SANUMION') {
            isAdmin=true; this.innerText='ADMIN ON'; this.style.background='#28a745';
            document.getElementById('pullBtn').style.display='block';
            setInterval(saveData, 5000); applyAdminLock();
        }
    } else { location.reload(); }
    toggleMenu();
};

document.getElementById('themeBtn').onclick = () => {
    const th = ['', 'theme-cyberpunk', 'theme-dark'];
    const cur = document.body.className;
    let next = th[(th.indexOf(cur) + 1) % th.length];
    document.body.className = next;
};

window.addEventListener('resize', applyResponsiveScale);
document.addEventListener('input', recalc);
updateUI(); updateDeadlineBanner();
</script>
</body>
</html>
