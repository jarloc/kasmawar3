<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=1024">
<title>LAPORAN KAS GANG MAWAR 3</title>
<style>
:root{
 --bg:#f5f5f5;--card:#ffffff;--text:#000000;--border:#cccccc;--accent:#4caf50;--danger:#d9534f;--success:#28a745;--yellow:#fff200;--font:Arial,sans-serif;
}

/* --- LOGO STYLING --- */
.logo-mawar-container {
    position: fixed; top: 10px; left: 15px; z-index: 1001; display: flex; flex-direction: column; align-items: flex-start;
}
.logo-img {
    width: 100px; height: auto; filter: drop-shadow(0 0 5px rgba(0,0,0,0.3)); transition: all 0.3s;
}
.logo-welcome {
    width: 450px; height: auto; margin-bottom: 20px; filter: drop-shadow(0 0 15px #00ffcc);
}
#userGreeting {
    font-size: 0.75rem; font-weight: bold; margin-top: 5px; color: var(--text); text-shadow: 1px 1px 2px rgba(0,0,0,0.1); display: none; background: rgba(255,255,255,0.6); padding: 2px 8px; border-radius: 4px; border: 1px solid var(--border);
}

/* --- SAFARI FIX --- */
input:disabled {
  -webkit-text-fill-color: currentcolor !important; color: inherit !important; opacity: 1 !important; background-color: inherit; border-color: transparent;
}

button {
  padding: 20px 32px; font-size: 1.2rem; border-radius: 12px; font-weight: 600; cursor: pointer; text-transform: uppercase; border: 0; transition: all 0.2s;
}
.menu-items button { width: 100%; margin-bottom: 12px; }

@media screen and (max-width: 768px) {
  #tbMasuk input, #tbKeluar input, .saldo, .total, #totalMasuk, #totalKeluar, .saldo-akhir { font-weight: 800 !important; font-size: 0.9rem; }
}

#welcomeScreen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; color: #fff; z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
}
#welcomeScreen h1 { font-size: 2.2rem; color: #00ffcc; text-shadow: 0 0 15px #00ffcc; margin: 0 20px 10px; font-family: Arial, sans-serif; }
#welcomeScreen p { font-size: 1rem; color: #aaa; text-transform: none; margin-bottom: 40px; font-family: Arial, sans-serif; padding: 0 20px; }
#enterBtn { padding: 15px 80px; background: #00ffcc; color: #000; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; text-transform: uppercase; font-size: 1.2rem; box-shadow: 0 0 20px rgba(0,255,204,0.4); }

#modalPengunjung { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3000; padding:20px; box-sizing:border-box; }
.pengunjung-content { background:#fff; color:#000; padding:20px; border-radius:10px; max-width:600px; margin:0 auto; max-height:80vh; overflow-y:auto; }

body{font-family:var(--font);background:var(--bg);margin:0;padding:20px;text-transform:uppercase;color:var(--text);-webkit-font-smoothing: antialiased;}
header{text-align:center;font-size:2rem;margin-bottom:5px}
.update-info {text-align:center; font-size:0.85rem; color:#666; margin-bottom:10px; font-weight:normal; text-transform:none;}
#deadline-banner { background: #333; color: #fff; padding: 10px; margin: 10px 16px; border-radius: 8px; font-weight: bold; overflow: hidden; white-space: nowrap; }
#deadline-banner marquee { font-size: 1.1rem; }
.tgl-aman { color: #00ff00; } .tgl-waspada { color: #ffff00; animation: blink 0.8s infinite; } .tgl-lewat { color: #ff4444; animation: pulse 1.5s infinite; } 
@keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
.menu-container {position:fixed; top:12px; right:12px; z-index:1000; display:flex; flex-direction:column; align-items:flex-end; gap:8px}
.menu-items {display:none; flex-direction:column; gap:8px; background:rgba(0,0,0,0.9); padding:12px; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.4); width: 250px;}
.menu-items.show {display:flex}
button.main-menu {background:#333; color:#fff; border:2px solid #fff; padding: 15px 25px;}
button.primary{background:var(--accent);color:#fff}
button.off{background:#999;color:#fff}
button.warning{background:#f0ad4e;color:#fff;border:1px solid #fff}
.block{margin:16px;padding:14px;background:var(--card);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.08);position:relative;transition:all 0.3s}
.block h2{font-size:1.3rem;margin-bottom:10px;text-align:center}
.pulse-line { display:none; height:2px; width:100%; background:linear-gradient(90deg, transparent, #00ffcc, #ff00ff, transparent); position:relative; margin-bottom:15px; overflow:hidden; }
.pulse-line::after { content:""; position:absolute; left:-100%; width:100%; height:100%; background:linear-gradient(90deg, transparent, #fff, transparent); animation: pulse-move 2s infinite linear; }
@keyframes pulse-move { 0% { left: -100%; } 100% { left: 100%; } }
.grand-total-table{width:100%;border-collapse:collapse;margin-top:10px}
.grand-total-table th, .grand-total-table td{border:1px solid var(--border);padding:8px;text-align:center;font-weight:700}
#totalMasuk { background:var(--success); color:#ffffff; }
#totalKeluar { background:var(--danger); color:#ffffff; }
.saldo-akhir { background:var(--yellow); color:#000000; }
.note-box {border:2px dashed var(--border); padding:20px; background:rgba(0,0,0,0.03); border-radius:12px; margin-top:20px;}
#catatanWarga { width:100%; background:transparent; border:0; color:var(--text); font-family:inherit; font-size:1.1rem; resize:none; text-transform:none; min-height:50px; overflow:hidden; line-height:1.5; white-space: pre-wrap; word-wrap: break-word; display: block; }
#catatanPrint { display: none; white-space: pre-wrap; font-size:1.1rem; line-height:1.5; text-transform:none; }
table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--border);padding:6px;text-align:left}
th{text-align:center; background:#eee; color:#000}
input{padding:4px;border-radius:6px;border:1px solid #ccc;width:100%;box-sizing:border-box;text-transform:none;font-family:inherit; color:inherit; background:transparent;}

/* --- CYBERPUNK THEME --- */
.theme-cyberpunk{--bg:#050505;--card:#0f0f0f;--text:#00ffcc;--border:#ff00ff;--accent:#ffff00;--yellow:#ffff00;}
.theme-cyberpunk .pulse-line { display:block; }
.theme-cyberpunk .block { border: 1px solid #00ffcc; box-shadow: 0 0 15px rgba(0,255,204,0.3); }
.theme-cyberpunk th { background:#1a1a1a; color:#ff00ff; border: 1px solid #00ffcc; }
.theme-cyberpunk td { border: 1px solid #ff00ff; }
.theme-cyberpunk tr:nth-child(odd) td { border-color: #00ffcc; }
.theme-cyberpunk tr:nth-child(even) td { border-color: #ffff00; }
.theme-cyberpunk input, .theme-cyberpunk textarea { color:#fff; text-shadow: 0 0 5px #fff; }
.theme-cyberpunk #totalMasuk { background:#00ff00; color:#000 !important; box-shadow: 0 0 10px #00ff00; }
.theme-cyberpunk #totalKeluar { background:#ff0000; color:#fff !important; box-shadow: 0 0 10px #ff0000; }
.theme-cyberpunk .saldo-akhir { background:#ffff00; color:#000 !important; box-shadow: 0 0 10px #ffff00; }
.theme-cyberpunk .menu-items button { background: #ff00ff !important; color: #000000 !important; box-shadow: 0 0 15px #ff00ff; border: 2px solid #00ffcc; }
.theme-cyberpunk #adminBtn.primary { background: #00ffcc !important; color: #000000 !important; box-shadow: 0 0 15px #00ffcc; }
.theme-cyberpunk #userGreeting { background: rgba(0,255,204,0.2); border-color: #00ffcc; text-shadow: 0 0 5px #00ffcc; }

.theme-dark{--bg:#1e1e1e;--text:#eee;--card:#2a2a2a;--border:#444}
.theme-dark #userGreeting { background: rgba(0,0,0,0.5); border-color: #444; }
.theme-blue{--bg:#eef4ff;--text:#102040;--card:#fff}

#checklistModal, #usulanModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; overflow-y:auto; padding:20px; box-sizing:border-box; }
.checklist-content, .usulan-content { background:#fff; color:#000; padding:20px; border-radius:10px; max-width:980px; margin:0 auto; }
.usulan-content h1 { text-align:center; background:#ff9800; color:#fff; padding:10px; margin:0; }
.usulan-btn-container { display:flex; justify-content:center; gap:10px; margin:15px 0; }
.btn-buat { background:#2196F3; color:#fff; padding:10px 20px; }
.btn-respon { background:#673AB7; color:#fff; padding:10px 20px; }
.table-usulan { width:100%; border-collapse:collapse; margin-top:10px; }
.table-usulan th { background:#333; color:#fff; }
.table-usulan td { font-size:0.85rem; text-transform:none; }
.vote-box { display:flex; flex-direction:column; gap:4px; font-size:0.75rem; }
.vote-count { font-weight:bold; color:#28a745; }
.vote-names { font-style:italic; color:#666; font-size:0.7rem; }
#formInputUsulan { display:none; border:2px solid #2196F3; padding:15px; margin-bottom:15px; border-radius:8px; }

.status-v { background:#93c47d; color:#000; }
.status-x { background:#e06666; color:#000; }

.admin-action { display: none; width: 40px; text-align: center; }
#adminTools { display:none; flex-direction:column; gap:8px; border-top:1px solid #555; padding-top:10px; }

/* --- NEW HARDWARE SECURITY STYLE --- */
.btn-reset-hw { background: #d9534f; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; margin-top: 5px; }
</style>
</head>
<body>

<div id="welcomeScreen">
    <img src="logo.png" alt="LOGO MAWAR 3" class="logo-welcome">
    <h1>SELAMAT DATANG DI WEBSITE KAS GANG MAWAR 3</h1>
    <p>Built and developed by Fajar Ilmanosa Viar <b>V10.5 Supreme Security</b> Copyright ¬© 2026 Gang Mawar 3 . All Rights Reserved.</p>
    <button id="enterBtn" onclick="masukWeb()">MASUK</button>
</div>

<div class="logo-mawar-container">
    <img src="logo.png" alt="LOGO" class="logo-img">
    <div id="userGreeting">Selamat datang Bpk. ...</div>
</div>

<div id="modalPengunjung">
    <div class="pengunjung-content">
        <h2 style="text-align:center; border-bottom:2px solid #000; padding-bottom:10px;">DAFTAR PENGUNJUNG</h2>
        <button id="btnHapusPengunjung" onclick="hapusRiwayatPengunjung()" style="width:100%; background:orange; color:#000; font-weight:bold; margin-bottom:10px; display:none; border-radius:8px; border:none; padding:10px;">‚ö†Ô∏è HAPUS SEMUA RIWAYAT</button>
        <div id="listPengunjung" style="margin:20px 0; font-size:0.9rem;"></div>
        <div id="paginationPengunjung" style="text-align:center; margin-bottom:15px;"></div>
        <div id="secLogAdmin" style="display:none; border-top:2px dashed #000; padding-top:15px; margin-top:15px;">
            <h3 style="text-align:center; color:red;">üö® LOG KEAMANAN SISTEM üö®</h3>
            <div id="listLogAdmin" style="font-size:0.85rem; color:#d9534f;"></div>
            <button onclick="hapusRiwayatLog()" style="width:100%; background:orange; color:#000; margin-top:10px; padding:10px; border-radius:5px;">üóëÔ∏è BERSIHKAN LOG PELANGGARAN</button>
        </div>
        <button onclick="document.getElementById('modalPengunjung').style.display='none'" style="width:100%; background:red; color:#fff;">TUTUP</button>
    </div>
</div>

<header>
  LAPORAN KAS GANG MAWAR 3
  <div style="margin-top:10px; text-align:center">
    <button onclick="prevMonth()">‚óÄ</button>
    <span id="periode" style="min-width:180px; display:inline-block">...</span>
    <button onclick="nextMonth()">‚ñ∂</button>
  </div>
  <div class="update-info" id="lastUpdate">TERAKHIR DI UPDATE PADA: -</div>
</header>

<div id="deadline-banner">
    <marquee id="deadline-text" scrollamount="5">Mengecek tanggal...</marquee>
</div>

<div class="menu-container">
    <button class="main-menu" onclick="toggleMenu()">‚ò∞ MENU</button>
    <div class="menu-items" id="menuItems">
        <button id="adminBtn" class="off">‚õî ADMIN OFF üîí</button>
        <div id="adminTools">
            <button onclick="tambahBaris('WARGA')" style="background:#28a745; color:#fff;">üë§ TAMBAH WARGA</button>
            <button onclick="tambahBaris('LAIN')" style="background:#17a2b8; color:#fff;">üì• TAMBAH PEMASUKAN</button>
            <button onclick="tambahBaris('KELUAR')" style="background:#d9534f; color:#fff;">üì§ TAMBAH PENGELUARAN</button>
            <button id="saveBtnManual" onclick="saveData()" style="background:#007bff; color:#fff;">üíæ SIMPAN DATA</button>
            <button id="listVisitorBtn" class="warning" onclick="openPengunjung()">üëÄ DAFTAR PENGUNJUNG</button>
        </div>
        <button onclick="openUsulan()" style="background:#ff9800; color:#fff;">üìù FORM USULAN WARGA</button>
        <button onclick="openChecklist()" class="primary">‚úÖ CHECKLIST KAS</button>
        <button id="themeBtn" class="primary">üé® GANTI TEMA</button>
        <button id="cetakBtn" class="primary">üñ®Ô∏è CETAK LAPORAN</button>
    </div>
</div>

<div class="block">
<h2>PEMASUKAN</h2>
<div class="pulse-line"></div>
<table>
<tr><th style="width:40px">Tgl</th><th style="width:25%">Nama</th><th style="width:50%">Keterangan</th><th style="width:15%">Masuk</th><th style="width:15%">Saldo</th><th class="admin-action">HPS</th></tr>
<tbody id="tbMasuk"></tbody>
</table>
</div>

<div class="block">
<h2>PENGELUARAN</h2>
<div class="pulse-line"></div>
<table>
<tr><th style="width:30px">Tgl</th><th style="width:40%">Keterangan</th><th style="width:8%">Qty</th><th style="width:25%">Harga</th><th style="width:25%">Total</th><th class="admin-action">HPS</th></tr>
<tbody id="tbKeluar"></tbody>
</table>
</div>

<div class="block">
<h2>GRAND TOTAL</h2>
<div class="pulse-line"></div>
<table class="grand-total-table">
<tr><th>TOTAL UANG MASUK</th><th>TOTAL UANG KELUAR</th><th>SALDO AKHIR</th></tr>
<tr><td id="totalMasuk">0</td><td id="totalKeluar">0</td><td id="saldoAkhir" class="saldo-akhir">0</td></tr>
</table>
</div>

<div class="block note-box">
  <h2 style="text-align:left; font-size:1.1rem; border-bottom:1px solid var(--border); padding-bottom:10px">üìå CATATAN PENTING</h2>
  <div class="pulse-line"></div>
  <textarea id="catatanWarga" class="editable" placeholder="Klik Admin ON untuk mengisi catatan di sini..." oninput="autoHeight(this)"></textarea>
  <div id="catatanPrint"></div>
</div>

<div style="text-align:center; margin-top:30px; margin-bottom:50px; padding:20px; border-top:1px solid var(--border); font-size:0.8rem; color:#888; text-transform:none;">
    Built and developed by <b style="color:var(--accent);">Fajar Ilmanosa Viar</b> V10.5 Supreme Copyright &copy; 2026 Gang Mawar 3 . All Rights Reserved.
</div>

<div id="checklistModal">
    <div style="text-align:center; margin-bottom:10px;">
        <button onclick="closeChecklist()" style="background:#d9534f; color:#fff;"> TUTUP </button>
        <button onclick="cetakChecklist()" style="background:var(--accent); color:#fff; margin-left:10px;">CETAK GAMBAR</button>
    </div>
    <div class="checklist-content" id="checklistPrintArea">
        <h1 id="judulChecklist" style="text-align:center; background:#92c694; padding:10px; margin:0;">CHECKLIST KAS GANG MAWAR 3</h1>
        <h2 id="subJudulChecklist" style="text-align:center; background:#d9ead3; padding:5px; border-bottom:2px solid #000; margin:0;">PERIODE 2026</h2>
        <table class="table-checklist">
            <thead>
                <tr>
                    <th rowspan="2" style="width:30px">No.</th>
                    <th rowspan="2">NAMA</th>
                    <th colspan="12" id="headerTahun">CHECKLIST KAS 2026</th>
                </tr>
                <tr>
                    <th>JAN</th><th>FEB</th><th>MAR</th><th>APR</th><th>MEI</th><th>JUN</th>
                    <th>JUL</th><th>AGT</th><th>SEP</th><th>OKT</th><th>NOV</th><th>DES</th>
                </tr>
            </thead>
            <tbody id="tbChecklist"></tbody>
        </table>
    </div>
</div>

<div id="usulanModal">
    <div style="text-align:center; margin-bottom:10px;">
        <button onclick="document.getElementById('usulanModal').style.display='none'" style="background:#d9534f; color:#fff;"> TUTUP </button>
    </div>
    <div class="usulan-content">
        <h1>üìù FORM USULAN WARGA</h1>
        <div class="usulan-btn-container">
            <button class="btn-buat" onclick="showInputUsulan()">‚ûï BUAT USULAN BARU</button>
            <button class="btn-respon" onclick="aktifkanModeRespon()">ü§ù BERI RESPON PADA USULAN</button>
        </div>

        <div id="formInputUsulan">
            <h4 style="margin-top:0;">TULIS USULAN ANDA:</h4>
            <textarea id="txtUsulan" style="width:100%; height:80px; padding:10px; box-sizing:border-box; border-radius:5px;" placeholder="Silahkan tulis usulan anda di sini..."></textarea>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
                <button onclick="batalUsulan()" style="background:#aaa; font-size:0.9rem; padding:8px 15px;">BATAL</button>
                <button onclick="kirimUsulan()" style="background:#2196F3; color:#fff; font-size:0.9rem; padding:8px 15px;">KIRIM USULAN</button>
            </div>
        </div>

        <div id="containerVotingRespon" style="display:none; background:#e8f5e9; padding:10px; border-radius:8px; margin-bottom:10px; text-align:center;">
            <p style="margin:0 0 10px 0; font-weight:bold; color:#2e7d32;">MODE RESPON AKTIF : KLIK TOMBOL ‚úÖ / ‚ùå PADA USULAN YG ADA. JIKA SUDAH, KLIK TOMBOL SELESAI RESPON</p>
            <button onclick="selesaiRespon()" style="background:#2e7d32; color:#fff; padding:5px 15px; font-size:0.8rem;">SELESAI RESPON</button>
        </div>

        <table class="table-usulan">
            <thead id="headUsulan"></thead>
            <tbody id="tbUsulan"></tbody>
        </table>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyAn5Iw4cI8bRSGuyRr3TNNVWzQA-duRHvk",
    authDomain: "kasmawar3-59c18.firebaseapp.com",
    databaseURL: "https://kasmawar3-59c18-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "kasmawar3-59c18",
    storageBucket: "kasmawar3-59c18.firebasestorage.app",
    messagingSenderId: "643313437210",
    appId: "1:643313437210:web:7377bbd6e4cd9aa33b5fa3",
    measurementId: "G-KY0GS26WNT"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const daftarKunci = {
    "D3/2": "RIZAL", "D3/3": "ROMI", "D3/4": "TRI", "D3/5": "ANIS",
    "D3/6": "FAJAR DJAKA", "D3/7": "FAJAR SHANUM", "D3/10": "AGUS", "D3/11": "LUKMAN",
    "D2/16": "IRAWAN", "D2/17": "RIAN", "D2/18": "MULYADIE", "D2/19": "HELDI",
    "D2/20": "HILMAN", "D2/21": "HILMAN", "D2/22": "NANO", "D2/23": "TEGUH"
};

const skrg = new Date();
let bulan = skrg.getMonth(), tahun = skrg.getFullYear();
let isAdmin=false, currentTheme='', currentUserName='', modeRespon=false;
const namaBulan=['JANUARI','FEBRUARI','MARET','APRIL','MEI','JUNI','JULI','AGUSTUS','SEPTEMBER','OKTOBER','NOVEMBER','DESEMBER'];
const namaAnggotaAwal=['SISA KAS SEBELUMNYA','RIZAL','ROMI','TRI','ANIS','FAJAR DJAKA','FAJAR SHANUM','AGUS','LUKMAN','IRAWAN','RIAN','MULYADIE','HELDI','HILMAN','NANO','TEGUH'];

/* --- SUPREME SECURITY HARDWARE GENERATOR --- */
async function getSupremeFingerprint() {
    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
    ctx.fillText("Mawar3-V10.2-Supreme-Sec", 2, 2);
    const b64 = canvas.toDataURL(); let hash = 0;
    for (let i = 0; i < b64.length; i++) { hash = ((hash << 5) - hash) + b64.charCodeAt(i); hash |= 0; }
    return "HW-" + Math.abs(hash).toString(16).toUpperCase() + "-" + screen.width;
}

async function masukWeb() {
    let kunci = prompt("SILAHKAN MASUKKAN NOMOR BLOK RUMAH ANDA:");
    if (!kunci) return;
    
    // Pembersihan cerdas: buang kata BLOK, NO, titik, spasi, dash
    let raw = kunci.toUpperCase().replace(/BLOK/g, '').replace(/NO/g, '').replace(/[\s\.\-]/g, '');
    
    // Jika warga ngetik D220, D221, dll (Hilman)
    if (raw.includes("D220") || raw.includes("D221") || raw.includes("D2/20") || raw.includes("D2/21")) { await prosesMasukHardware("HILMAN", "D2/20-21"); return; }
    
    // Logika menyisipkan "/" jika warga hanya ngetik angka atau format D223
    let bersih = raw;
    if (!bersih.includes('/') && (bersih.startsWith('D3') || bersih.startsWith('D2')) && bersih.length >= 3) {
        if(bersih.startsWith('D3')) bersih = "D3/" + bersih.substring(2);
        else if(bersih.startsWith('D2')) bersih = "D2/" + bersih.substring(2);
    }
    
    // Jika warga hanya ngetik angkanya saja (misal: 23), kita cari di daftarKunci
    if (!isNaN(bersih)) {
        let foundKey = Object.keys(daftarKunci).find(key => key.split('/')[1] === bersih);
        if (foundKey) bersih = foundKey;
    }
    
    if (daftarKunci[bersih]) { await prosesMasukHardware(daftarKunci[bersih], bersih); } else { alert("NOMOR BLOK TIDAK TERDAFTAR! Pastikan nomor yg anda masukan sudah benar!"); }
}

async function prosesMasukHardware(namaUser, kode) {
    const fPrint = await getSupremeFingerprint();
    const namaIdentitas = namaUser + " (" + kode + ")";
    
    // Check if hardware is already registered to another user
    const hardwareRef = db.ref('perangkat_terdaftar/' + fPrint);
    const snap = await hardwareRef.once('value');
    const registeredUser = snap.val();

    if (registeredUser && registeredUser !== namaIdentitas) {
        alert("üõë AKSES DITOLAK!\nSebelumnya anda sudah terdaftar login sebagai " + registeredUser + ".\nJika anda bukan nama tersebut silahkan hubungi bendahara untuk melakukan reset daftar warga");
        db.ref('log_pelanggaran_hardware').push({ penyamar: namaIdentitas, pemilik_asli: registeredUser, hw: fPrint, waktu: new Date().toLocaleString() });
        return;
    }

    if (!registeredUser) {
        hardwareRef.set(namaIdentitas);
    }
    
    currentUserName = namaIdentitas;
    db.ref('pengunjung_situs').push({ nama: currentUserName, hw: fPrint, waktu: new Date().toLocaleString('id-ID') });
    
    // Munculkan teks sapaan di bawah logo
    document.getElementById('userGreeting').innerText = "SELAMAT DATANG, BPK. " + namaUser;
    document.getElementById('userGreeting').style.display = 'block';
    
    document.getElementById('welcomeScreen').remove();
    window.scrollTo(0,0);
}

// --- ADMIN RESET FUNCTIONS ---
function resetHardware(hwID, namaWarga) {
    if (isAdmin && confirm("YAKIN RESET IDENTITAS HP " + namaWarga + "?")) {
        db.ref('perangkat_terdaftar/' + hwID).remove().then(() => { alert("IDENTITAS HP BERHASIL DIRESET!"); openPengunjung(); });
    }
}
function hapusRiwayatLog() { if(isAdmin && confirm("HAPUS SEMUA LOG PELANGGARAN?")) db.ref('log_pelanggaran_hardware').remove().then(()=>openPengunjung()); }

function toggleMenu() { document.getElementById('menuItems').classList.toggle('show'); }

// ================= FORM USULAN WARGA =================
function openUsulan() {
    toggleMenu();
    document.getElementById('usulanModal').style.display = 'block';
    loadUsulan();
}

function showInputUsulan() { document.getElementById('formInputUsulan').style.display = 'block'; }
function batalUsulan() { document.getElementById('formInputUsulan').style.display = 'none'; document.getElementById('txtUsulan').value = ''; }

function kirimUsulan() {
    const teks = document.getElementById('txtUsulan').value;
    if(!teks) return alert("Usulan tidak boleh kosong!");
    const skrgLog = new Date();
    const tglJam = skrgLog.getDate() + "/" + (skrgLog.getMonth()+1) + "/" + skrgLog.getFullYear() + " " + skrgLog.getHours().toString().padStart(2,'0') + ":" + skrgLog.getMinutes().toString().padStart(2,'0');
    
    db.ref('usulan_warga').push({
        waktu: tglJam,
        nama: currentUserName,
        usulan: teks,
        setuju: [],
        tolak: []
    }).then(() => {
        alert("USULAN TERKIRIM!");
        batalUsulan();
        loadUsulan();
    });
}

function aktifkanModeRespon() { modeRespon = true; document.getElementById('containerVotingRespon').style.display = 'block'; loadUsulan(); }
function selesaiRespon() { modeRespon = false; document.getElementById('containerVotingRespon').style.display = 'none'; loadUsulan(); }

function loadUsulan() {
    const tb = document.getElementById('tbUsulan');
    const th = document.getElementById('headUsulan');
    
    let headerHTML = `<tr><th style="width:15%">TANGGAL & JAM</th><th style="width:20%">NAMA</th><th style="width:35%">USULAN</th><th style="width:30%">RESPON</th>`;
    if(isAdmin) headerHTML += `<th style="width:50px">HPS</th>`;
    headerHTML += `</tr>`;
    th.innerHTML = headerHTML;

    tb.innerHTML = "<tr><td colspan='5' style='text-align:center'>Memuat data usulan...</td></tr>";
    
    db.ref('usulan_warga').on('value', s => {
        const d = s.val();
        tb.innerHTML = "";
        if(!d) return tb.innerHTML = "<tr><td colspan='5' style='text-align:center'>Belum ada usulan masuk.</td></tr>";
        
        Object.keys(d).reverse().forEach(id => {
            const u = d[id];
            const namaPembuatMurni = u.nama.split(' (')[0];
            const setujus = u.setuju ? Object.values(u.setuju) : [];
            const tolaks = u.tolak ? Object.values(u.tolak) : [];
            const listSetujuMurni = setujus.map(n => n.split(' (')[0]);
            const listTolakMurni = tolaks.map(n => n.split(' (')[0]);
            
            const tr = document.createElement('tr');
            const sudahVoting = setujus.includes(currentUserName) || tolaks.includes(currentUserName);
            const isOwner = (u.nama === currentUserName);
            
            let rowHTML = `
                <td style="text-align:center">${u.waktu}</td>
                <td ${isAdmin ? 'contentEditable="true" onblur="updateUsulanAdmin(\''+id+'\', \'nama\', this.innerText)"' : ''}>${namaPembuatMurni}</td>
                <td ${isAdmin ? 'contentEditable="true" onblur="updateUsulanAdmin(\''+id+'\', \'usulan\', this.innerText)"' : ''}>${u.usulan}</td>
                <td>
                    <div class="vote-box">
                        <div class="vote-count">‚úÖ SETUJU: ${setujus.length}</div>
                        <div class="vote-names">${listSetujuMurni.join(', ')}</div>
                        <div class="vote-count" style="color:#d9534f">‚ùå TOLAK: ${tolaks.length}</div>
                        <div class="vote-names">${listTolakMurni.join(', ')}</div>
                        ${(modeRespon && !isOwner && !sudahVoting) ? `
                            <div style="margin-top:5px; display:flex; gap:5px;">
                                <button onclick="vote('${id}', 'setuju')" style="background:#28a745; color:#fff; font-size:0.7rem; padding:4px 8px;">‚úÖ</button>
                                <button onclick="vote('${id}', 'tolak')" style="background:#d9534f; color:#fff; font-size:0.7rem; padding:4px 8px;">‚ùå</button>
                            </div>
                        ` : ''}
                        ${(sudahVoting) ? `<div style="font-size:0.65rem; color:blue; margin-top:5px;">TERIMA KASIH, RESPON ANDA SUDAH MASUK.</div>` : ''}
                        ${(isOwner && modeRespon) ? `<div style="font-size:0.65rem; color:grey; margin-top:5px;">ANDA PEMBUAT USULAN INI, ANDA TIDAK DAPAT MEMBERI RESPON PADA USULAN SENDIRI.</div>` : ''}
                    </div>
                </td>
            `;
            if(isAdmin) rowHTML += `<td style="text-align:center"><button onclick="hapusUsulan('${id}')" style="background:#d9534f; color:#fff; border-radius:4px; padding:5px;">üóëÔ∏è</button></td>`;
            tr.innerHTML = rowHTML;
            tb.appendChild(tr);
        });
    });
}

function vote(id, tipe) {
    const teksTipe = (tipe === 'setuju') ? 'SETUJU' : 'TIDAK SETUJU';
    if(confirm(`YAKIN ${teksTipe}, PAK?`)) {
        db.ref(`usulan_warga/${id}/${tipe}`).push(currentUserName).then(() => { loadUsulan(); });
    }
}

function hapusUsulan(id) {
    if(!isAdmin) return;
    if(confirm("HAPUS USULAN INI, PAK?")) {
        db.ref(`usulan_warga/${id}`).remove().then(() => { alert("TERHAPUS!"); });
    }
}

function updateUsulanAdmin(id, field, value) {
    if(!isAdmin) return;
    db.ref(`usulan_warga/${id}`).update({ [field]: value });
}

// ================= LOGIKA PENGUNJUNG =================
let limitTampilVisitor = 50;
function openPengunjung() {
    toggleMenu();
    const modal = document.getElementById('modalPengunjung'), list = document.getElementById('listPengunjung'), secLog = document.getElementById('secLogAdmin'), listLog = document.getElementById('listLogAdmin'), btnHapus = document.getElementById('btnHapusPengunjung'), pagin = document.getElementById('paginationPengunjung');
    btnHapus.style.display = isAdmin ? 'block' : 'none';
    secLog.style.display = isAdmin ? 'block' : 'none';
    list.innerHTML = "Memuat daftar...";
    modal.style.display = 'block';

    db.ref('pengunjung_situs').limitToLast(500).once('value', s => {
        const d = s.val();
        if(d) {
            let allData = Object.values(d).reverse();
            let html = "<table style='width:100%;'><tr><th>NAMA & TANGGAL</th><th>AKSI HP</th></tr>";
            
            // Render hanya sejumlah limitTampilVisitor
            allData.slice(0, limitTampilVisitor).forEach(v => { 
                html += `<tr style='border-bottom:1px solid #eee;'>
                    <td style='padding:5px;'><b>${v.nama}</b><br><small>${v.waktu}</small></td>
                    <td style='text-align:center;'>${isAdmin ? `<button class="btn-reset-hw" onclick="resetHardware('${v.hw}','${v.nama}')">RESET HP</button>` : '-'}</td>
                </tr>`; 
            });
            list.innerHTML = html + "</table>";

            // Munculkan tombol load more jika data masih ada
            if(allData.length > limitTampilVisitor) {
                pagin.innerHTML = `<button onclick="limitTampilVisitor+=50; openPengunjung();" style="background:#eee; color:#000; font-size:0.8rem; padding:10px 20px; border:1px solid #ccc;">‚ûï TAMPILKAN 50 DATA LAGI</button>`;
            } else {
                pagin.innerHTML = `<small style='color:grey;'>Menampilkan ${allData.length} data terbaru.</small>`;
            }
        } else {
            list.innerHTML = "Belum ada riwayat pengunjung.";
            pagin.innerHTML = "";
        }
    });

    if(isAdmin) {
        listLog.innerHTML = "Memindai riwayat penyusup...";
        db.ref('log_pelanggaran_hardware').limitToLast(500).once('value', s => {
            const d = s.val(); let h = "";
            if(d) {
                Object.values(d).reverse().forEach(v => { 
                    if(v.pemilik_asli === "PERCOBAAN_ADMIN_ILEGAL"){
                        h += `<p style='border-left:4px solid red; padding-left:10px; font-size:0.8rem; background:#fff1f1;'>üö® <b>${v.penyamar}</b> MENCOBA MASUK KE AKSES ADMIN!<br><small>${v.waktu}</small></p>`;
                    } else {
                        h += `<p style='border-left:4px solid red; padding-left:10px; font-size:0.8rem; background:#fff1f1;'>‚ö†Ô∏è HP <b>${v.pemilik_asli}</b> MENCOBA MASUK SEBAGAI <b>${v.penyamar}</b><br><small>${v.waktu}</small></p>`; 
                    }
                });
                listLog.innerHTML = h;
            } else {
                listLog.innerHTML = "<p style='text-align:center; color:green;'>TIDAK ADA PERCOBAAN ILEGAL.</p>";
            }
        });
    }
}

function hapusRiwayatPengunjung() {
    if (!isAdmin) return;
    if (confirm("HAPUS SEMUA RIWAYAT, TUAN?")) {
        db.ref('pengunjung_situs').remove(); db.ref('percobaan_admin_gagal').remove();
        alert("BERSIH!"); limitTampilVisitor = 50; openPengunjung(); 
    }
}

// ================= LOGIKA KAS ASLI =================
function tambahBaris(tipe) {
    if(tipe === 'KELUAR'){
        const tb = document.getElementById('tbKeluar');
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input class='editable' type='date'></td>
                        <td><input class='editable'></td>
                        <td><input class='editable' value='0'></td>
                        <td><input class='editable' value='0'></td>
                        <td class='total'>0</td>
                        <td class='admin-action' style='display:table-cell'><button onclick='hapusBaris(this)' style='background:red; color:white; padding:5px 10px; font-size:0.8rem;'>X</button></td>`;
        tb.appendChild(tr);
    } else {
        const tb = document.getElementById('tbMasuk');
        const tr = document.createElement('tr');
        const namaDefault = (tipe === 'WARGA') ? 'WARGA BARU' : 'PEMASUKAN LAIN-LAIN';
        tr.innerHTML = `<td><input class='editable' type='date'></td>
                        <td><input class='editable' value='${namaDefault}'></td>
                        <td><input class='editable'></td>
                        <td><input class='editable' value='0'></td>
                        <td class='saldo'>0</td>
                        <td class='admin-action' style='display:table-cell'><button onclick='hapusBaris(this)' style='background:red; color:white; padding:5px 10px; font-size:0.8rem;'>X</button></td>`;
        tb.appendChild(tr);
    }
    recalc();
}

function hapusBaris(btn) {
    if(confirm("HAPUS BARIS INI, TUAN?")) { btn.parentElement.parentElement.remove(); recalc(); }
}

function buildTables(){
 document.getElementById('tbMasuk').innerHTML=''; document.getElementById('tbKeluar').innerHTML='';
 namaAnggotaAwal.forEach(n=>{
  const tr=document.createElement('tr');
  tr.innerHTML=`<td><input class='editable' type='date'></td><td><input class='editable' value='${n}'></td><td><input class='editable'></td><td><input class='editable' value='0'></td><td class='saldo'>0</td><td class='admin-action'></td>`;
  document.getElementById('tbMasuk').appendChild(tr);
 });
 for(let i=0;i<5;i++){
  const tr=document.createElement('tr');
  tr.innerHTML=`<td><input class='editable' type='date'></td><td><input class='editable'></td><td><input class='editable' value='0'></td><td><input class='editable' value='0'></td><td class='total'>0</td><td class='admin-action' style='display:${isAdmin?"table-cell":"none"}'><button onclick='hapusBaris(this)' style='background:red; color:white; padding:5px 10px; font-size:0.8rem;'>X</button></td>`;
  document.getElementById('tbKeluar').appendChild(tr);
 }
}

function recalc(){
 let tM=0, tK=0, runM=0;
 document.querySelectorAll('#tbMasuk tr').forEach(tr=>{
  let u=parseInt(tr.children[3].firstChild.value.replace(/[^0-9]/g,''))||0; runM+=u; tM+=u;
  tr.children[3].firstChild.value=u.toLocaleString('id-ID');
  tr.children[4].textContent=runM.toLocaleString('id-ID');
  const ketVal=tr.children[2].firstChild.value.toUpperCase();
  const inputs=tr.querySelectorAll('input');
  const keywordsSuccess = ["LUNAS", "SUDAH BAYAR", "SISA KAS", "BAYAR TUNAI", "BAYAR TRANSFER"];
  if(ketVal.includes('BELUM BAYAR')){ inputs.forEach(inp=>{ inp.style.backgroundColor='var(--danger)'; inp.style.color='#fff'; }); }
  else if(keywordsSuccess.some(k => ketVal.includes(k))){ inputs.forEach(inp=>{ inp.style.backgroundColor='var(--success)'; inp.style.color='#fff'; }); }
  else { inputs.forEach(inp=>{ inputs.forEach(inp=>{ inp.style.backgroundColor='transparent'; inp.style.color='var(--text)'; }); }); }
 });
 document.querySelectorAll('#tbKeluar tr').forEach(tr=>{
  let q=parseInt(tr.children[2].firstChild.value.replace(/[^0-9]/g,''))||0, h=parseInt(tr.children[3].firstChild.value.replace(/[^0-9]/g,''))||0, t=q*h; tK+=t;
  tr.children[2].firstChild.value=q.toLocaleString('id-ID'); tr.children[3].firstChild.value=h.toLocaleString('id-ID'); tr.children[4].textContent=t.toLocaleString('id-ID');
 });
 document.getElementById('totalMasuk').textContent=tM.toLocaleString('id-ID');
 document.getElementById('totalKeluar').textContent=tK.toLocaleString('id-ID');
 document.getElementById('saldoAkhir').textContent=(tM-tK).toLocaleString('id-ID');
 applyAdminLock();
}

function applyAdminLock(){ 
    document.querySelectorAll('.editable').forEach(i=>{ i.disabled=!isAdmin; i.style.cursor = !isAdmin ? "default" : "text"; });
    document.querySelectorAll('.admin-action').forEach(el => el.style.display = isAdmin ? 'table-cell' : 'none');
}

function loadData(){
 buildTables();
 db.ref('kas_data/'+bulan+'-'+tahun).once('value', s=>{
  const d=s.val();
  if(d && d.masuk){
   document.getElementById('tbMasuk').innerHTML='';
   d.masuk.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input class='editable' type='date' value='${r.tanggal||''}'></td><td><input class='editable' value='${r.nama||''}'></td><td><input class='editable' value='${r.ket||''}'></td><td><input class='editable' value='${r.uang||'0'}'></td><td class='saldo'>0</td><td class='admin-action'><button onclick='hapusBaris(this)' style='background:red; color:white; padding:5px 10px; font-size:0.8rem;'>X</button></td>`;
    document.getElementById('tbMasuk').appendChild(tr);
   });
   if(d.keluar) {
    document.getElementById('tbKeluar').innerHTML='';
    d.keluar.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td><input class='editable' type='date' value='${r.tanggal||''}'></td><td><input class='editable' value='${r.ket||''}'></td><td><input class='editable' value='${r.qty||'0'}'></td><td><input class='editable' value='${r.harga||'0'}'></td><td class='total'>0</td><td class='admin-action'><button onclick='hapusBaris(this)' style='background:red; color:white; padding:5px 10px; font-size:0.8rem;'>X</button></td>`;
        document.getElementById('tbKeluar').appendChild(tr);
    });
   }
   if(d.updated) document.getElementById('lastUpdate').textContent = "TERAKHIR DI UPDATE PADA: " + d.updated;
  }
  
  let pm=bulan-1, pt=tahun; if(pm<0){pm=11; pt--;}
  db.ref('kas_data/'+pm+'-'+pt).once('value', sPrev=>{
    const dPrev=sPrev.val(); let sL=0;
    if(dPrev && dPrev.masuk){
        let mt=0, kt=0;
        dPrev.masuk.forEach(r=>{ if(r.uang) mt += parseInt(r.uang.replace(/[^0-9]/g,'')) || 0; });
        if(dPrev.keluar) dPrev.keluar.forEach(r=>{ let q = parseInt(r.qty.replace(/[^0-9]/g,'')) || 0, h = parseInt(r.harga.replace(/[^0-9]/g,'')) || 0; kt += (q * h); });
        sL = mt - kt;
    }
    const trSisa = document.querySelector('#tbMasuk tr');
    if(trSisa && trSisa.children[1].firstChild.value === 'SISA KAS SEBELUMNYA'){
        trSisa.children[0].firstChild.value = `${tahun}-${(bulan + 1).toString().padStart(2, '0')}-01`;
        trSisa.children[2].firstChild.value = `SISA KAS ${namaBulan[pm]} ${pt}`;
        trSisa.children[3].firstChild.value = sL.toLocaleString('id-ID');
        recalc();
    }
  });
  recalc();
 });
 db.ref('kas_data/catatan_umum').once('value', snapshot => {
    const cat = snapshot.val(); const ta = document.getElementById('catatanWarga');
    if(cat) { ta.value = cat; document.getElementById('catatanPrint').innerText = cat; setTimeout(()=>autoHeight(ta), 150); } 
 });
}

function saveData(){
 if(!isAdmin) return;
 const btn = document.getElementById('saveBtnManual');
 const originalText = btn.textContent;
 btn.textContent = "PROSES...";
 
 const tgl = new Date(), formatUpdate = tgl.getDate() + " " + namaBulan[tgl.getMonth()] + " " + tgl.getFullYear() + ", " + tgl.getHours().toString().padStart(2,'0') + ":" + tgl.getMinutes().toString().padStart(2,'0') + " WIB";
 const m=[...document.querySelectorAll('#tbMasuk tr')].map(tr=>({tanggal:tr.children[0].firstChild.value, nama:tr.children[1].firstChild.value, ket:tr.children[2].firstChild.value, uang:tr.children[3].firstChild.value}));
 const k=[...document.querySelectorAll('#tbKeluar tr')].map(tr=>({tanggal:tr.children[0].firstChild.value, ket:tr.children[1].firstChild.value, qty:tr.children[2].firstChild.value, harga:tr.children[3].firstChild.value}));
 
 db.ref('kas_data/'+bulan+'-'+tahun).update({masuk:m, keluar:k, updated:formatUpdate})
 .then(() => {
    db.ref('kas_data/catatan_umum').set(document.getElementById('catatanWarga').value);
    btn.textContent = originalText;
    alert("‚úÖ DATA BERHASIL DISIMPAN KE SERVER, TUAN!");
 });
}

async function openChecklist() {
    toggleMenu(); const modal = document.getElementById('checklistModal'), tb = document.getElementById('tbChecklist');
    document.getElementById('subJudulChecklist').innerText = `PERIODE ${tahun}`;
    tb.innerHTML = '<tr><td colspan="14">Memindai Data...</td></tr>'; modal.style.display = 'block';
    let listWarga = [...namaAnggotaAwal];
    for(let m=0; m<=11; m++){
        const snap = await db.ref(`kas_data/${m}-${tahun}`).once('value'), d = snap.val();
        if(d && d.masuk) d.masuk.forEach(r => { 
            if(r.nama && !listWarga.includes(r.nama) && r.nama !== 'PEMASUKAN LAIN-LAIN' && r.nama !== 'SISA KAS SEBELUMNYA') listWarga.push(r.nama);
        });
    }
    const matrix = {};
    for (let m = 0; m <= 11; m++) {
        const snap = await db.ref(`kas_data/${m}-${tahun}`).once('value'), d = snap.val();
        listWarga.forEach((nama, idx) => {
            if (idx === 0) return;
            if (!matrix[nama]) matrix[nama] = Array(12).fill('X');
            if (d && d.masuk) {
                const row = d.masuk.find(r => r.nama === nama);
                if (row && ["LUNAS", "SUDAH BAYAR", "BAYAR TUNAI", "BAYAR TRANSFER"].some(k => (row.ket||'').toUpperCase().includes(k))) matrix[nama][m] = '‚úì';
            }
        });
    }
    tb.innerHTML = '';
    Object.keys(matrix).forEach((nama, i) => {
        const tr = document.createElement('tr');
        let html = `<td>${i+1}</td><td style="text-align:left">Bpk. ${nama}</td>`;
        matrix[nama].forEach(status => { html += `<td class="${status === '‚úì' ? 'status-v' : 'status-x'}">${status}</td>`; });
        tr.innerHTML = html; tb.appendChild(tr);
    });
}

function closeChecklist() { document.getElementById('checklistModal').style.display = 'none'; }
function cetakChecklist() { html2canvas(document.getElementById('checklistPrintArea'), {scale:2}).then(c => { const l = document.createElement('a'); l.download = `CHECKLIST_KAS_${tahun}.jpg`; l.href = c.toDataURL('image/jpeg', 0.9); l.click(); }); }

document.getElementById('adminBtn').onclick = function() {
 if(!isAdmin){
  let u=prompt('USER'), p=prompt('PASS');
  if(u && u.toUpperCase()==='\x41\x44\x4D\x49\x4E' && p && p.toUpperCase()==='\x53\x41\x4E\x55\x4D\x49\x4O\x4E'){
   isAdmin=true; this.textContent='‚úÖ ADMIN ON üîì'; this.className='primary';
   document.getElementById('adminTools').style.display='flex';
   applyAdminLock(); recalc(); alert('BERHASIL!');
  } else { 
   db.ref('log_pelanggaran_hardware').push({ penyamar: currentUserName, pemilik_asli: "PERCOBAAN_ADMIN_ILEGAL", hw: "ADMIN_SEC", waktu: new Date().toLocaleString() });
   alert('SALAH!'); 
  }
 } else {
  isAdmin=false; this.textContent='‚õî ADMIN OFF üîí'; this.className='off';
  document.getElementById('adminTools').style.display='none';
  applyAdminLock();
 }
 toggleMenu();
};

function prevMonth(){ bulan--; if(bulan<0){bulan=11; tahun--;} updateUI(); }
function nextMonth(){ bulan++; if(bulan>11){bulan=0; tahun++;} updateUI(); }
function updateUI(){ document.getElementById('periode').textContent=namaBulan[bulan]+' '+tahun; loadData(); }
function autoHeight(elem) { elem.style.height = "1px"; elem.style.height = (elem.scrollHeight) + "px"; }
function updateDeadlineBanner() {
    const hariIni = new Date().getDate();
    const banner = document.getElementById('deadline-text');
    if (hariIni <= 3) banner.innerHTML = `<span class="tgl-aman">üî• REMINDER: Awal bulan nih bapak-bapak, jangan lupa bayar uang kas yaa üî•</span>`; 
    else if (hariIni <= 7) banner.innerHTML = `<span class="tgl-waspada">‚ö†Ô∏è PERHATIAN: Batas iuran uang kas ditunggu sampai tanggal 7 ‚ö†Ô∏è Lewat dari tanggal 7 nama anda masuk ke kolom "CATATAN PENTING" ‚ö†Ô∏è</span>`; 
    else banner.innerHTML = `<span class="tgl-lewat">üõë Bagi yang belum bayar uang kas harap untuk segera melakukan pembayaran! üõë Cek apakah nama anda tertera di kolom "CATATAN PENTING" pada bagian bawah halaman ini! üõë </span>`;
}

document.getElementById('themeBtn').onclick=()=>{
 const th=['theme-cyberpunk','theme-dark','theme-blue',''];
 let i=th.indexOf(currentTheme)+1; if(i>=th.length) i=0;
 if(currentTheme) document.body.classList.remove(currentTheme);
 currentTheme=th[i]; if(currentTheme) document.body.classList.add(currentTheme);
};

document.getElementById('cetakBtn').onclick=()=>{
 toggleMenu(); window.scrollTo(0,0);
 const areaAdmin = document.getElementById('catatanWarga'), areaPrint = document.getElementById('catatanPrint'), banner = document.getElementById('deadline-banner');
 banner.style.display = 'none'; areaPrint.innerText = areaAdmin.value; areaAdmin.style.display = 'none'; areaPrint.style.display = 'block';
 setTimeout(()=>{
  html2canvas(document.body,{scale:2}).then(c=>{
   const l=document.createElement('a'); l.download=`KAS_${namaBulan[bulan]}_${tahun}.jpg`; l.href=c.toDataURL('image/jpeg',0.9); l.click();
   banner.style.display = 'block'; areaAdmin.style.display = 'block'; areaPrint.style.display = 'none';
  });
 },500);
};

window.addEventListener('beforeunload', function (e) {
    e.preventDefault();
    e.returnValue = '';
});

document.addEventListener('input', recalc);
updateUI(); updateDeadlineBanner();
</script>
</body>
</html>
