<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta id="viewportMeta" name="viewport" content="width=device-width, initial-scale=1.0">
<title>LAPORAN KAS GANG MAWAR 3</title>
<style>
:root{
 --bg:#f5f5f5;--card:#ffffff;--text:#000000;--border:#cccccc;--accent:#4caf50;--danger:#d9534f;--success:#28a745;--yellow:#fff200;--font:Arial,sans-serif;
}
* { box-sizing: border-box; }
body { font-family: var(--font); background: var(--bg); margin: 0; padding: 0; text-transform: uppercase; color: var(--text); overflow-x: hidden; }

/* --- WELCOME SCREEN --- */
#welcomeScreen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
    background: #000; color: #fff; z-index: 9999; 
    display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
}
#welcomeScreen h1 { font-size: 2rem; margin: 0 20px 10px; color: #00ffcc; text-shadow: 0 0 10px #00ffcc; }
#welcomeInput { 
    padding: 15px; width: 300px; border-radius: 8px; border: 2px solid #00ffcc; 
    background: transparent; color: #fff; text-align: center; font-size: 18px; outline: none; margin-bottom: 20px;
}
#enterBtn { padding: 15px 60px; background: #00ffcc; color: #000; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; }

/* --- MAIN WRAPPER (FORCED DESKTOP 1024px) --- */
#mainWrapper {
    width: 1024px; margin: 0 auto; background: var(--bg); padding: 20px;
    transform-origin: top center; display: none; position: relative;
}

header{text-align:center;font-size:2.8rem;margin-bottom:5px; font-weight: bold;}
.update-info {text-align:center; font-size:0.9rem; color:#666; margin-bottom:15px; text-transform:none;}

#deadline-banner { background: #333; color: #fff; padding: 15px; margin: 10px 0; border-radius: 8px; font-weight: bold; overflow: hidden; }
#deadline-banner marquee { font-size: 1.4rem; }

.menu-container {position:fixed; top:20px; right:20px; z-index:1000; display:flex; flex-direction:column; align-items:flex-end; gap:8px}
.menu-items {display:none; flex-direction:column; gap:10px; background:rgba(0,0,0,0.95); padding:20px; border-radius:12px; box-shadow:0 4px 30px rgba(0,0,0,0.5)}
.menu-items.show {display:flex}

button{padding:14px 22px; border:0; border-radius:8px; font-weight:bold; cursor:pointer; text-transform:uppercase;}
button.main-menu {background:#000; color:#fff; border:2px solid #00ffcc}
button.primary{background:var(--accent);color:#fff}
button.off{background:#666;color:#fff}
button.warning{background:#f0ad4e;color:#fff;border:1px solid #fff}

.block{margin-bottom:25px;padding:25px;background:var(--card);border-radius:16px;box-shadow:0 4px 15px rgba(0,0,0,.1); clear: both;}
.block h2{font-size:1.8rem;margin-bottom:20px;text-align:center; border-bottom: 2px solid #eee; padding-bottom: 10px;}

table{width:100%;border-collapse:collapse; table-layout: fixed;}
th,td{border:1px solid var(--border);padding:12px;text-align:left; font-size: 1.1rem; overflow: hidden;}
th{background:#f2f2f2; color:#000; text-align:center;}
input{padding:8px;border-radius:6px;border:1px solid #ccc;width:100%;font-size:1.1rem; text-transform: uppercase;}
input[disabled]{background:transparent; color:var(--text); border:1px solid transparent}

.grand-total-table td{padding:20px; font-size: 1.5rem; text-align:center; font-weight: bold;}
#totalMasuk { background:var(--success); color:#fff; }
#totalKeluar { background:var(--danger); color:#fff; }
.saldo-akhir { background:var(--yellow); color:#000; }

#catatanWarga { width:100%; background:transparent; border:0; font-family:inherit; font-size:1.3rem; resize:none; text-transform:none; min-height:100px; line-height:1.5;}

/* CYBERPUNK THEME */
.theme-cyberpunk{--bg:#050505;--card:#0d0d0d;--text:#00ffcc;--border:#ff00ff;--accent:#ffff00;--yellow:#ffff00;}
.theme-cyberpunk .block { border: 1px solid #00ffcc; }
.theme-cyberpunk input, .theme-cyberpunk textarea { color:#fff; }
.theme-cyberpunk th { background: #1a1a1a; color: #00ffcc; }

/* MODALS */
#checklistModal, #visitorModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:2000; overflow:auto; padding:20px; }
.modal-content { background:#fff; color:#000; padding:30px; border-radius:15px; width:1000px; margin:0 auto; }
</style>
</head>
<body>

<div id="welcomeScreen">
    <h1>KAS GANG MAWAR 3</h1>
    <p>Admin: Fajar Ilmanosa Viar Â© 2026</p>
    <input type="text" id="welcomeInput" placeholder="MASUKKAN NAMA ANDA">
    <button id="enterBtn" onclick="masukWeb()">ENTER</button>
</div>

<div id="mainWrapper">
    <header>
      LAPORAN KAS GANG MAWAR 3
      <div style="margin-top:15px;">
        <button onclick="prevMonth()">â—€</button>
        <span id="periode" style="min-width:300px; display:inline-block">...</span>
        <button onclick="nextMonth()">â–¶</button>
      </div>
      <div class="update-info" id="lastUpdate">UPDATE: -</div>
    </header>

    <div id="deadline-banner">
        <marquee id="deadline-text" scrollamount="7">Checking system...</marquee>
    </div>

    <div class="menu-container">
        <button class="main-menu" onclick="toggleMenu()">â˜° MENU</button>
        <div class="menu-items" id="menuItems">
            <button id="adminBtn" class="off">LOGIN ADMIN</button>
            <button id="pullBtn" class="warning" style="display:none" onclick="tarikSaldo()">TARIK SALDO LALU</button>
            <button id="visitorBtn" class="warning" style="display:none" onclick="openVisitors()">LOG PENGUNJUNG</button>
            <button onclick="openChecklist()" class="primary">CHECKLIST MATRIX</button>
            <button id="themeBtn" class="primary">GANTI TEMA</button>
            <button id="cetakBtn" class="primary">DOWNLOAD JPG</button>
        </div>
    </div>

    <div class="block">
        <h2>PEMASUKAN</h2>
        <table>
            <thead><tr><th style="width:110px">TGL</th><th style="width:220px">NAMA</th><th>KETERANGAN</th><th style="width:160px">MASUK</th><th style="width:160px">SALDO</th></tr></thead>
            <tbody id="tbMasuk"></tbody>
        </table>
    </div>

    <div class="block">
        <h2>PENGELUARAN</h2>
        <table>
            <thead><tr><th style="width:110px">TGL</th><th>KETERANGAN</th><th style="width:90px">QTY</th><th style="width:160px">HARGA</th><th style="width:160px">TOTAL</th></tr></thead>
            <tbody id="tbKeluar"></tbody>
        </table>
    </div>

    <div class="block">
        <h2>GRAND TOTAL</h2>
        <table class="grand-total-table">
            <tr><th>TOTAL MASUK</th><th>TOTAL KELUAR</th><th>SALDO AKHIR</th></tr>
            <tr><td id="totalMasuk">0</td><td id="totalKeluar">0</td><td id="saldoAkhir" class="saldo-akhir">0</td></tr>
        </table>
    </div>

    <div class="block">
      <h2 style="text-align:left;">ðŸ“Œ CATATAN</h2>
      <textarea id="catatanWarga" class="editable" placeholder="..."></textarea>
    </div>
</div>

<div id="visitorModal"><div class="modal-content"><button onclick="document.getElementById('visitorModal').style.display='none'">TUTUP</button><h2>LOG PENGUNJUNG</h2><table style="width:100%"><tbody id="tbVisitors"></tbody></table></div></div>
<div id="checklistModal"><div class="modal-content"><button onclick="document.getElementById('checklistModal').style.display='none'">TUTUP</button><h2>MATRIX 2026</h2><table style="width:100%; border:1px solid #000; font-size:0.8rem"><thead><tr id="headCheck"><th>NAMA</th></tr></thead><tbody id="tbChecklist"></tbody></table></div></div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyAn5Iw4cI8bRSGuyRr3TNNVWzQA-duRHvk",
    authDomain: "kasmawar3-59c18.firebaseapp.com",
    databaseURL: "https://kasmawar3-59c18-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "kasmawar3-59c18",
    storageBucket: "kasmawar3-59c18.firebasestorage.app",
    messagingSenderId: "643313437210",
    appId: "1:643313437210:web:7377bbd6e4cd9aa33b5fa3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const skrg = new Date();
let bulan = skrg.getMonth(), tahun = skrg.getFullYear(), isAdmin = false, autoSaveTimer = null;
const namaBulan=['JANUARI','FEBRUARI','MARET','APRIL','MEI','JUNI','JULI','AGUSTUS','SEPTEMBER','OKTOBER','NOVEMBER','DESEMBER'];
const namaAnggota=['SISA KAS SEBELUMNYA','RIZAL','ROMI','TRI','ANIS','FAJAR DJAKA','FAJAR SHANUM','AGUS','LUKMAN','IRAWAN','RIAN','MULYADIE','HELDI','HILMAN','NANO','TEGUH'];

function applyResponsiveScale() {
    const wrapper = document.getElementById('mainWrapper');
    const screenWidth = window.innerWidth;
    const targetWidth = 1024;
    if (screenWidth < targetWidth) {
        const scale = screenWidth / targetWidth;
        wrapper.style.transform = `scale(${scale})`;
        document.body.style.height = (wrapper.offsetHeight * scale) + "px";
    } else {
        wrapper.style.transform = `none`;
        document.body.style.height = "auto";
    }
}

function masukWeb() {
    const nama = document.getElementById('welcomeInput').value.trim();
    if (!nama) return alert("Isi Nama!");
    db.ref('pengunjung_situs').push({ nama, waktu: new Date().toLocaleString('id-ID'), ts: firebase.database.ServerValue.TIMESTAMP });
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('mainWrapper').style.display = 'block';
    applyResponsiveScale();
    window.scrollTo(0,0);
}

function buildTables(){
    const tbm = document.getElementById('tbMasuk'); tbm.innerHTML='';
    const tbk = document.getElementById('tbKeluar'); tbk.innerHTML='';
    namaAnggota.forEach(n => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input class='editable' type='date'></td><td><input class='editable' value='${n}'></td><td><input class='editable'></td><td><input class='editable' value='0'></td><td>0</td>`;
        tbm.appendChild(tr);
    });
    for(let i=0; i<10; i++){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><input class='editable' type='date'></td><td><input class='editable'></td><td><input class='editable' value='0'></td><td><input class='editable' value='0'></td><td>0</td>`;
        tbk.appendChild(tr);
    }
}

function recalc(){
    let tm=0, tk=0, run=0;
    document.querySelectorAll('#tbMasuk tr').forEach(tr => {
        let u = parseInt(tr.children[3].firstChild.value.replace(/[^0-9]/g,''))||0; 
        run += u; tm += u;
        tr.children[3].firstChild.value = u.toLocaleString('id-ID');
        tr.children[4].textContent = run.toLocaleString('id-ID');
        let ket = tr.children[2].firstChild.value.toUpperCase();
        tr.querySelectorAll('input').forEach(i => {
            if(ket.includes('LUNAS')) i.style.color = '#28a745';
            else if(ket.includes('BELUM')) i.style.color = '#d9534f';
            else i.style.color = 'inherit';
        });
    });
    document.querySelectorAll('#tbKeluar tr').forEach(tr => {
        let q = parseInt(tr.children[2].firstChild.value.replace(/[^0-9]/g,''))||0;
        let h = parseInt(tr.children[3].firstChild.value.replace(/[^0-9]/g,''))||0;
        let tot = q * h; tk += tot;
        tr.children[2].firstChild.value = q.toLocaleString('id-ID');
        tr.children[3].firstChild.value = h.toLocaleString('id-ID');
        tr.children[4].textContent = tot.toLocaleString('id-ID');
    });
    document.getElementById('totalMasuk').textContent = tm.toLocaleString('id-ID');
    document.getElementById('totalKeluar').textContent = tk.toLocaleString('id-ID');
    document.getElementById('saldoAkhir').textContent = (tm-tk).toLocaleString('id-ID');
}

function loadData(){
    buildTables();
    db.ref('kas_data/'+bulan+'-'+tahun).once('value', s => {
        const d = s.val();
        if(d){
            if(d.masuk) d.masuk.forEach((r,i) => {
                const tr = document.querySelectorAll('#tbMasuk tr')[i];
                if(tr){ tr.children[0].firstChild.value=r.t||''; tr.children[1].firstChild.value=r.n||namaAnggota[i]; tr.children[2].firstChild.value=r.k||''; tr.children[3].firstChild.value=r.u||'0'; }
            });
            if(d.keluar) d.keluar.forEach((r,i) => {
                const tr = document.querySelectorAll('#tbKeluar tr')[i];
                if(tr){ tr.children[0].firstChild.value=r.t||''; tr.children[1].firstChild.value=r.k||''; tr.children[2].firstChild.value=r.q||'0'; tr.children[3].firstChild.value=r.h||'0'; }
            });
            if(d.upd) document.getElementById('lastUpdate').textContent = "UPDATE: " + d.upd;
        }
        recalc(); applyAdminLock();
    });
    db.ref('kas_data/catatan').once('value', s => { if(s.val()) document.getElementById('catatanWarga').value = s.val(); });
}

function saveData(){
    if(!isAdmin) return;
    const m = [...document.querySelectorAll('#tbMasuk tr')].map(tr => ({t:tr.children[0].firstChild.value, n:tr.children[1].firstChild.value, k:tr.children[2].firstChild.value, u:tr.children[3].firstChild.value}));
    const k = [...document.querySelectorAll('#tbKeluar tr')].map(tr => ({t:tr.children[0].firstChild.value, k:tr.children[1].firstChild.value, q:tr.children[2].firstChild.value, h:tr.children[3].firstChild.value}));
    db.ref('kas_data/'+bulan+'-'+tahun).update({masuk:m, keluar:k, upd: new Date().toLocaleString('id-ID')});
    db.ref('kas_data/catatan').set(document.getElementById('catatanWarga').value);
}

function tarikSaldo(){
    let blLalu = bulan - 1, thLalu = tahun;
    if(blLalu < 0) { blLalu = 11; thLalu--; }
    db.ref(`kas_data/${blLalu}-${thLalu}`).once('value', s => {
        const d = s.val();
        if(d){
            let tm=0, tk=0;
            d.masuk.forEach(r => tm += parseInt(r.u.replace(/\./g,''))||0);
            d.keluar.forEach(r => { tk += (parseInt(r.q.replace(/\./g,''))||0) * (parseInt(r.h.replace(/\./g,''))||0); });
            document.querySelectorAll('#tbMasuk tr')[0].children[3].firstChild.value = (tm-tk).toLocaleString('id-ID');
            document.querySelectorAll('#tbMasuk tr')[0].children[2].firstChild.value = "DARI BULAN LALU";
            recalc(); alert("Saldo Berhasil!");
        }
    });
}

async function openChecklist(){
    toggleMenu(); document.getElementById('checklistModal').style.display='block';
    const head = document.getElementById('headCheck'); head.innerHTML = "<th>NAMA</th>";
    namaBulan.forEach(b => head.innerHTML += `<th>${b.substring(0,3)}</th>`);
    const tb = document.getElementById('tbChecklist'); tb.innerHTML = "Loading...";
    const allData = {};
    for(let m=0; m<12; m++) { const s = await db.ref(`kas_data/${m}-${tahun}`).once('value'); allData[m] = s.val(); }
    let html = "";
    namaAnggota.forEach((nama, idx) => {
        if(idx === 0) return;
        html += `<tr><td style="font-weight:bold">${nama}</td>`;
        for(let m=0; m<12; m++){
            let st = "X", bg = "#ffcccc";
            if(allData[m] && allData[m].masuk){
                const r = allData[m].masuk.find(x => x.n === nama);
                if(r && (r.k||'').toUpperCase().includes('LUNAS')){ st="âœ“"; bg="#ccffcc"; }
            }
            html += `<td style="background:${bg}; text-align:center">${st}</td>`;
        }
        html += "</tr>";
    });
    tb.innerHTML = html;
}

function openVisitors(){
    toggleMenu(); document.getElementById('visitorModal').style.display='block';
    db.ref('pengunjung_situs').limitToLast(15).once('value', s => {
        let h = ""; s.forEach(c => { h = `<tr><td>${c.val().nama}</td><td>${c.val().waktu}</td></tr>` + h; });
        document.getElementById('tbVisitors').innerHTML = h;
    });
}

document.getElementById('adminBtn').onclick = function(){
    if(!isAdmin){
        if(prompt('PASS:') === 'SANUMION'){
            isAdmin=true; this.textContent="ADMIN: ON"; this.className="primary";
            document.getElementById('pullBtn').style.display='block';
            document.getElementById('visitorBtn').style.display='block';
            autoSaveTimer = setInterval(saveData, 3000);
            applyAdminLock();
        }
    } else {
        isAdmin=false; this.textContent="LOGIN ADMIN"; this.className="off";
        clearInterval(autoSaveTimer); applyAdminLock();
    }
    toggleMenu();
};

function toggleMenu() { document.getElementById('menuItems').classList.toggle('show'); }
function prevMonth(){ bulan--; if(bulan<0){bulan=11; tahun--;} updateUI(); }
function nextMonth(){ bulan++; if(bulan>11){bulan=0; tahun++;} updateUI(); }
function updateUI(){ 
    document.getElementById('periode').textContent=namaBulan[bulan]+' '+tahun; 
    loadData(); 
    const d = new Date().getDate();
    document.getElementById('deadline-text').innerText = d <= 10 ? `AYO BAYAR KAS! TGL ${d}` : `DEADLINE LEWAT! TGL ${d}`;
}
function applyAdminLock(){ document.querySelectorAll('.editable').forEach(i=>i.disabled=!isAdmin); }

document.getElementById('themeBtn').onclick = () => document.body.classList.toggle('theme-cyberpunk');
document.getElementById('cetakBtn').onclick = () => {
    html2canvas(document.getElementById('mainWrapper')).then(c => {
        const l = document.createElement('a'); l.download=`KAS_${namaBulan[bulan]}.png`; l.href=c.toDataURL(); l.click();
    });
};

window.addEventListener('resize', applyResponsiveScale);
document.addEventListener('input', recalc);
updateUI();
</script>
</body>
</html>
